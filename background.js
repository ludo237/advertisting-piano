var active_notes = {}
var active_tab_id = null

var notes = [
    52, 52, 56, 59, 56, 59, 56, 59, 56, 59, 52, 64, 68, 52, 56, 59, 68, 69, 56, 59, 56, 59, 69, 71, 56, 59, 52, 52, 56, 59, 56, 59, 56, 59, 56, 59, 52, 71, 68, 52, 56, 59, 68, 64, 56, 59, 56, 59, 64, 72, 56, 59, 57, 57, 60, 64, 60, 64, 60, 64, 60, 64, 57, 72, 71, 57, 60, 64, 71, 69, 60, 64, 60, 64, 69, 76, 60, 64, 57, 57, 60, 64, 60, 64, 60, 64, 60, 64, 57, 76, 57, 60, 64, 76, 60, 64, 60, 64, 76, 77, 60, 64, 50, 50, 53, 57, 53, 57, 53, 57, 53, 57, 50, 77, 76, 50, 53, 57, 76, 74, 53, 57, 53, 57, 74, 76, 53, 57, 57, 57, 60, 64, 60, 64, 60, 64, 60, 64, 57, 76, 74, 57, 60, 64, 74, 72, 60, 64, 60, 64, 72, 71, 60, 64, 52, 52, 56, 59, 56, 59, 56, 59, 56, 59, 52, 71, 72, 52, 56, 59, 56, 59, 56, 59, 72, 71, 71, 69, 56, 59, 57, 57, 60, 64, 60, 64, 60, 64, 69, 71, 60, 64, 71, 72, 72, 74, 74, 76, 76, 77, 77, 79, 79, 81, 55, 81, 81, 55, 59, 62, 81, 81, 59, 62, 59, 62, 81, 81, 59, 62, 55, 81, 81, 55, 59, 62, 81, 81, 59, 62, 59, 62, 81, 81, 59, 62, 48, 81, 79, 48, 52, 55, 52, 55, 52, 55, 79, 78, 78, 79, 52, 55, 48, 48, 52, 55, 79, 52, 55, 52, 55, 77, 52, 55, 55, 77, 77, 55, 59, 62, 77, 77, 59, 62, 59, 62, 77, 77, 59, 62, 55, 77, 77, 55, 59, 62, 77, 77, 59, 62, 59, 62, 77, 77, 59, 62, 48, 77, 76, 48, 52, 55, 52, 55, 52, 55, 76, 75, 75, 76, 52, 55, 48, 76, 48, 52, 55, 76, 52, 55, 52, 55, 76, 74, 52, 55, 52, 74, 74, 52, 56, 59, 74, 74, 56, 59, 56, 59, 74, 74, 56, 59, 52, 74, 74, 52, 56, 59, 74, 74, 56, 59, 56, 59, 74, 74, 56, 59, 57, 74, 72, 57, 60, 64, 60, 64, 60, 64, 72, 71, 71, 69, 60, 64, 57, 69, 57, 60, 64, 81, 60, 64, 60, 64, 81, 77, 60, 64, 50, 77, 74, 50, 53, 57, 74, 71, 53, 57, 53, 57, 71, 72, 53, 57, 52, 52, 56, 59, 72, 71, 56, 59, 56, 59, 71, 69, 56, 59, 57, 57, 60, 64, 60, 64, 60, 64, 69, 57, 60, 64, 45, 57, 45
]
var attack = [
    67, 0, 79, 79, 0, 0, 77, 77, 0, 0, 64, 0, 85, 0, 84, 84, 0, 78, 0, 0, 80, 80, 0, 84, 0, 0, 67, 0, 83, 83, 0, 0, 78, 78, 0, 0, 68, 0, 74, 0, 83, 83, 0, 66, 0, 0, 74, 74, 0, 92, 0, 0, 73, 0, 84, 84, 0, 0, 80, 80, 0, 0, 70, 0, 74, 0, 87, 87, 0, 71, 0, 0, 77, 77, 0, 91, 0, 0, 68, 0, 93, 93, 0, 0, 77, 77, 0, 0, 69, 0, 0, 84, 84, 70, 0, 0, 77, 77, 0, 76, 0, 0, 65, 0, 85, 85, 0, 0, 78, 78, 0, 0, 71, 0, 75, 0, 80, 80, 0, 77, 0, 0, 76, 76, 0, 83, 0, 0, 75, 0, 93, 93, 0, 0, 75, 75, 0, 0, 68, 0, 72, 0, 81, 81, 0, 70, 0, 0, 79, 79, 0, 73, 0, 0, 65, 0, 81, 81, 0, 0, 77, 77, 0, 0, 69, 0, 79, 0, 83, 83, 0, 0, 77, 77, 0, 75, 0, 72, 0, 0, 74, 0, 90, 90, 0, 0, 80, 80, 0, 82, 0, 0, 0, 80, 0, 78, 0, 84, 0, 79, 0, 79, 0, 82, 70, 0, 80, 0, 90, 90, 0, 74, 0, 0, 83, 83, 0, 77, 0, 0, 73, 0, 80, 0, 90, 90, 0, 75, 0, 0, 83, 83, 0, 75, 0, 0, 62, 0, 73, 0, 82, 82, 0, 0, 75, 75, 0, 74, 0, 82, 0, 0, 63, 0, 82, 82, 0, 0, 0, 76, 76, 63, 0, 0, 77, 0, 82, 0, 89, 89, 0, 79, 0, 0, 80, 80, 0, 77, 0, 0, 70, 0, 72, 0, 90, 90, 0, 77, 0, 0, 77, 77, 0, 79, 0, 0, 66, 0, 73, 0, 79, 79, 0, 0, 76, 76, 0, 73, 0, 77, 0, 0, 69, 0, 0, 84, 84, 70, 0, 0, 81, 81, 0, 68, 0, 0, 72, 0, 70, 0, 88, 88, 0, 74, 0, 0, 78, 78, 0, 73, 0, 0, 68, 0, 74, 0, 82, 82, 0, 77, 0, 0, 76, 76, 0, 78, 0, 0, 71, 0, 68, 0, 87, 87, 0, 0, 80, 80, 0, 76, 0, 76, 0, 0, 68, 0, 0, 90, 90, 73, 0, 0, 80, 80, 0, 69, 0, 0, 63, 0, 67, 0, 82, 82, 0, 67, 0, 0, 76, 76, 0, 80, 0, 0, 72, 0, 83, 83, 0, 78, 0, 0, 76, 76, 0, 74, 0, 0, 73, 0, 91, 91, 0, 0, 78, 78, 0, 61, 0, 0, 64, 0, 0
]

var current_note = 0

function on_send_headers(request) {
    if (request.tabId == active_tab_id) { // Make sure we only listen on active tabs
        MIDI.noteOn(0, notes[current_note], attack[current_note])

        active_notes[request.requestId] = notes[current_note]
        current_note = (current_note + 1)
        if (current_note > notes.length) current_note = 0
    }
}

function on_error_occured(request) {
    request_end(request)
}

function on_completed(request) {
    request_end(request)
}

function request_end(request) {
    var entry = active_notes[request.requestId]
    if (entry != undefined) {
        MIDI.noteOff(0, entry, 0.1)
        delete active_notes[request.requestId]
    } 
}

MIDI.loadPlugin({
    soundfontUrl: "./soundfont/",
    instrument: "acoustic_grand_piano",
    onprogress: function(state, progress) {
        console.log(state, progress);
    },
    onsuccess: function() {
        var match_all = ["http://*/*", "https://*/*"]
        chrome.webRequest.onSendHeaders.addListener(on_send_headers, {urls: match_all})
        chrome.webRequest.onErrorOccurred.addListener(on_error_occured, {urls: match_all})
        chrome.webRequest.onCompleted.addListener(on_completed, {urls: match_all})

        // Keep track of the current tab id
        chrome.tabs.onActiveChanged.addListener(function (tab_id, select_info) {
            active_tab_id = tab_id
        })
    }
});